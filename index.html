<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Culto Ao Vivo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React e Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS para manipulação de Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, addDoc, deleteDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyCYaOPtQdD1hU29awdgeN-rEGaoLGBGYBM",
          authDomain: "gestao-de-culto.firebaseapp.com",
          projectId: "gestao-de-culto",
          storageBucket: "gestao-de-culto.appspot.com",
          messagingSenderId: "843566675046",
          appId: "1:843566675046:web:cc1e54a813827f4502a9a7",
          measurementId: "G-LH68N60385"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestao-de-culto-default';

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.firestore = { doc, getDoc, setDoc, onSnapshot, collection, getDocs, addDoc, deleteDoc, serverTimestamp, updateDoc };
            window.firebaseAuth = { signInAnonymously, onAuthStateChanged };
        } catch (e) {
            console.error("Erro ao inicializar o Firebase: ", e);
            document.getElementById('root').innerHTML = '<div style="color:red; text-align:center; padding: 20px;">Não foi possível conectar ao Firebase. Verifique o console para mais detalhes.</div>';
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .hidden-file-input { display: none; }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
            Carregando aplicativo...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // Ícones (sem alterações)
        const SvgIcon = ({ size = 24, className = '', children }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg> );
        const icons = { Plus: (props) => <SvgIcon {...props}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></SvgIcon>, Play: (props) => <SvgIcon {...props}><polygon points="5 3 19 12 5 21 5 3" /></SvgIcon>, Pause: (props) => <SvgIcon {...props}><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></SvgIcon>, Settings: (props) => <SvgIcon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></SvgIcon>, Monitor: (props) => <SvgIcon {...props}><rect x="2" y="3" width="20" height="14" rx="2" ry="2" /><line x1="8" y1="21" x2="16" y2="21" /><line x1="12" y1="17" x2="12" y2="21" /></SvgIcon>, Server: (props) => <SvgIcon {...props}><rect x="2" y="2" width="20" height="8" rx="2" ry="2" /><rect x="2" y="14" width="20" height="8" rx="2" ry="2" /><line x1="6" y1="6" x2="6.01" y2="6" /><line x1="6" y1="18" x2="6.01" y2="18" /></SvgIcon>, ChevronUp: (props) => <SvgIcon {...props}><polyline points="18 15 12 9 6 15" /></SvgIcon>, ChevronDown: (props) => <SvgIcon {...props}><polyline points="6 9 12 15 18 9" /></SvgIcon>, Trash2: (props) => <SvgIcon {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></SvgIcon>, CheckCircle: (props) => <SvgIcon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></SvgIcon>, RotateCcw: (props) => <SvgIcon {...props}><path d="M3 2v6h6" /><path d="M3 13a9 9 0 1 0 3-7.7L3 8" /></SvgIcon>, Clock: (props) => <SvgIcon {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></SvgIcon>, UploadCloud: (props) => <SvgIcon {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></SvgIcon>, DownloadCloud: (props) => <SvgIcon {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m8 17 4 4 4-4" /></SvgIcon>, Save: (props) => <SvgIcon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></SvgIcon>, Users: (props) => <SvgIcon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></SvgIcon>, UserCheck: (props) => <SvgIcon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><polyline points="16 11 18 13 22 9" /></SvgIcon>, Mic: (props) => <SvgIcon {...props}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" y1="19" x2="12" y2="23" /><line x1="8" y1="23" x2="16" y2="23" /></SvgIcon>, Volume2: (props) => <SvgIcon {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></SvgIcon>, Camera: (props) => <SvgIcon {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></SvgIcon>, Lightbulb: (props) => <SvgIcon {...props}><path d="M9 18h6" /><path d="M10 22h4" /><path d="M12 2a7 7 0 0 0-5 2.24" /><path d="M12 2v6a2 2 0 0 1-2 2H8a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1a2 2 0 0 0-2-2h-2a2 2 0 0 1-2-2V2Z" /></SvgIcon>, Info: (props) => <SvgIcon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></SvgIcon>, ChevronRight: (props) => <SvgIcon {...props}><polyline points="9 18 15 12 9 6" /></SvgIcon>, Power: (props) => <SvgIcon {...props}><path d="M18.36 6.64a9 9 0 1 1-12.73 0" /><line x1="12" y1="2" x2="12" y2="12" /></SvgIcon>, FilePlus: (props) => <SvgIcon {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="12" y1="18" x2="12" y2="12" /><line x1="9" y1="15" x2="15" y2="15" /></SvgIcon> };

        // NOVO: Componente de Modal reutilizável
        const Modal = ({ show, onClose, title, children, footer }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-white rounded-lg p-6 w-full max-w-md shadow-xl" onClick={e => e.stopPropagation()}>
                        <h2 className="text-xl font-semibold mb-4">{title}</h2>
                        <div className="mb-6">{children}</div>
                        <div className="flex justify-end gap-3">
                            {footer}
                        </div>
                    </div>
                </div>
            );
        };

        // NOVO: Hook para facilitar o uso do Modal
        const useModal = () => {
            const [modalState, setModalState] = useState({ show: false, title: '', content: null, footer: null });
            const showModal = ({ title, content, footer }) => setModalState({ show: true, title, content, footer });
            const hideModal = () => setModalState({ show: false, title: '', content: null, footer: null });
            return { modalState, showModal, hideModal };
        };

        // Estado inicial para um plano novo
        const getInitialState = () => ({
            plan: {
                items: [],
                cultInfo: { date: new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric'}), coordenadorTecnico: 'A definir', staff: 'A definir', lead: 'A definir', som: 'A definir', projecao: 'A definir', iluminacao: 'A definir', transmissao: 'A definir', pregador: 'A definir', startTime: '19:00' }
            },
            live: { currentItemIndex: 0, isRunning: false, itemStartTime: null, accumulatedTime: 0, actualStartTime: null }
        });

        const App = () => {
            const [plan, setPlan] = useState(getInitialState().plan);
            const [live, setLive] = useState(getInitialState().live);
            const [isLoading, setIsLoading] = useState(true);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [viewMode, setViewMode] = useState(null);
            
            const { db, appId, firestore, auth, firebaseAuth } = window;

            // ALTERADO: Referências de documentos separadas para plano e estado ao vivo
            const planDocRef = useMemo(() => db ? firestore.doc(db, "artifacts", appId, "public", "data", "worship-plan") : null, [db, appId]);
            const liveDocRef = useMemo(() => db ? firestore.doc(db, "artifacts", appId, "public", "data", "live-state") : null, [db, appId]);
            const presetsCollectionRef = useMemo(() => db ? firestore.collection(db, "artifacts", appId, "public", "data", "presets") : null, [db, appId]);

            // Efeito para definir o modo de visualização (coordenador ou equipe)
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                setViewMode(urlParams.get('view') || 'coordinator');
            }, []);

            // ALTERADO: Lógica de autenticação mais robusta
            useEffect(() => {
                if (!auth || !firebaseAuth) { setIsLoading(false); return; }
                const unsubscribe = firebaseAuth.onAuthStateChanged(user => {
                    if (user) {
                        setIsAuthReady(true);
                    } else {
                        firebaseAuth.signInAnonymously(auth).catch(error => {
                            console.error("Erro no login anônimo:", error);
                            setIsLoading(false);
                        });
                    }
                });
                return () => unsubscribe();
            }, [auth, firebaseAuth]);

            // ALTERADO: Listener para o documento do PLANO
            useEffect(() => {
                if (!isAuthReady || !planDocRef) { return; }
                const unsubscribe = firestore.onSnapshot(planDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setPlan(docSnap.data());
                    } else {
                        // Se não existe, cria um plano inicial
                        firestore.setDoc(planDocRef, getInitialState().plan);
                    }
                    setIsLoading(false);
                }, (error) => {
                    console.error("Erro no listener do plano:", error);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [isAuthReady, planDocRef]);

            // ALTERADO: Listener para o documento de ESTADO AO VIVO
            useEffect(() => {
                if (!isAuthReady || !liveDocRef) { return; }
                const unsubscribe = firestore.onSnapshot(liveDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setLive(docSnap.data());
                    } else {
                         // Se não existe, cria um estado ao vivo inicial
                        firestore.setDoc(liveDocRef, getInitialState().live);
                    }
                }, (error) => {
                    console.error("Erro no listener do estado ao vivo:", error);
                });
                return () => unsubscribe();
            }, [isAuthReady, liveDocRef]);

            if (isLoading || viewMode === null) {
                return <div className="flex justify-center items-center h-screen bg-gray-100">Carregando...</div>;
            }

            if (viewMode === 'team') {
                return <TeamView plan={plan} live={live} />;
            }

            return (
                <CoordinatorController 
                    plan={plan}
                    live={live}
                    planDocRef={planDocRef}
                    liveDocRef={liveDocRef}
                    presetsCollectionRef={presetsCollectionRef}
                />
            );
        };

        const CoordinatorController = ({ plan, live, planDocRef, liveDocRef, presetsCollectionRef }) => {
            const [mode, setMode] = useState('planning');
            const [showTechnical, setShowTechnical] = useState(true);
            const fileInputRef = useRef(null);
            const { modalState, showModal, hideModal } = useModal();
            const { firestore } = window;

            // Funções de manipulação do estado (agora mais granulares)
            const updatePlan = (newPlanData) => firestore.setDoc(planDocRef, newPlanData);
            const updateLive = (newLiveData) => firestore.setDoc(liveDocRef, newLiveData);

            const calculateStartTimes = (items, startTime) => {
                if (!startTime) { startTime = '00:00' }
                let cumulativeTime = new Date(`1970-01-01T${startTime}:00`);
                if (isNaN(cumulativeTime)) return items.map(item => ({...item, startTime: '--:--'}));
                return items.map(item => {
                    const itemStartTime = cumulativeTime.toTimeString().slice(0, 5);
                    cumulativeTime.setMinutes(cumulativeTime.getMinutes() + (Number(item.duration) || 0));
                    return { ...item, startTime: itemStartTime };
                });
            };

            const handleCultInfoChange = (field, value) => {
                const newCultInfo = { ...plan.cultInfo, [field]: value };
                let newItems = plan.items;
                if (field === 'startTime') {
                    newItems = calculateStartTimes(plan.items, value);
                }
                updatePlan({ ...plan, cultInfo: newCultInfo, items: newItems });
            };

            const addItem = () => {
                const newItem = { id: Date.now(), title: 'Novo Momento', duration: 5, type: 'palavra', responsible: 'A definir', description: '', technical: { projection: '-', sound: '-', microphone: '-', lighting: '-', camera: '-' }, completed: false, actualDuration: null, };
                const newItems = calculateStartTimes([...plan.items, newItem], plan.cultInfo.startTime);
                updatePlan({ ...plan, items: newItems });
            };
            
            // NOVO: Função para criar um plano limpo
            const handleNewPlan = () => {
                 showModal({
                    title: "Criar Novo Plano",
                    content: <p>Tem certeza que deseja limpar a ordem de culto atual? Todas as informações não salvas como preset serão perdidas.</p>,
                    footer: <>
                        <button onClick={hideModal} className="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button onClick={() => {
                            updatePlan(getInitialState().plan);
                            hideModal();
                        }} className="px-4 py-2 bg-blue-600 text-white rounded-md">Criar Novo</button>
                    </>
                });
            };

            const updateItem = (id, updates) => {
                let newItems = plan.items.map(item => item.id === id ? { ...item, ...updates } : item);
                if (updates.duration !== undefined) { newItems = calculateStartTimes(newItems, plan.cultInfo.startTime); }
                updatePlan({ ...plan, items: newItems });
            };
            
            const deleteItem = (id) => {
                showModal({
                    title: "Excluir Item",
                    content: <p>Tem certeza que deseja excluir este item?</p>,
                    footer: <>
                        <button onClick={hideModal} className="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button onClick={() => {
                            const newItems = calculateStartTimes(plan.items.filter(item => item.id !== id), plan.cultInfo.startTime);
                            updatePlan({ ...plan, items: newItems });
                            hideModal();
                        }} className="px-4 py-2 bg-red-600 text-white rounded-md">Excluir</button>
                    </>
                });
            };
            
            const moveItem = (index, direction) => {
                const currentItems = [...plan.items];
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= currentItems.length) return;
                const item = currentItems.splice(index, 1)[0];
                currentItems.splice(newIndex, 0, item);
                const newItems = calculateStartTimes(currentItems, plan.cultInfo.startTime);
                updatePlan({ ...plan, items: newItems });
            };

            const handleDownloadExcelTemplate = () => {
                const data = [{ title: "Música de Abertura", duration: 10, type: "música", responsible: "Ministério de Louvor", description: "Usar playback e projeção com letra." }];
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Ordem de Culto");
                worksheet["!cols"] = [ { wch: 30 }, { wch: 10 }, { wch: 15 }, { wch: 25 }, { wch: 50 }, ];
                XLSX.writeFile(workbook, "modelo_ordem_de_culto.xlsx");
            };

            const handleImportExcel = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        showModal({
                            title: "Importar Planilha",
                            content: <p>Isso substituirá a ordem de culto atual com os dados do arquivo. Deseja continuar?</p>,
                            footer: <>
                                <button onClick={() => { event.target.value = null; hideModal(); }} className="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                                <button onClick={() => {
                                    try {
                                        const data = e.target.result;
                                        const workbook = XLSX.read(data, { type: 'array' });
                                        const sheetName = workbook.SheetNames[0];
                                        const worksheet = workbook.Sheets[sheetName];
                                        const json = XLSX.utils.sheet_to_json(worksheet);
                                        const newItemsFromExcel = json.map(row => ({ id: Date.now() + Math.random(), title: row.title || 'Sem Título', duration: parseInt(row.duration, 10) || 5, type: row.type || 'palavra', responsible: row.responsible || 'A definir', description: row.description || '', technical: { projection: '-', sound: '-', microphone: '-', lighting: '-', camera: '-' }, completed: false, actualDuration: null, }));
                                        updatePlan({ ...plan, items: calculateStartTimes(newItemsFromExcel, plan.cultInfo.startTime) });
                                    } catch(error) {
                                        alert("Ocorreu um erro ao ler o arquivo Excel."); console.error("Erro no SheetJS:", error);
                                    } finally {
                                        hideModal();
                                        event.target.value = null;
                                    }
                                }} className="px-4 py-2 bg-green-600 text-white rounded-md">Importar</button>
                            </>
                        });
                    };
                    reader.readAsArrayBuffer(file);
                }
            };

            return (
                <>
                    <Modal {...modalState} onClose={hideModal} />
                    <div className="min-h-screen bg-gray-100 p-4">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                                <h1 className="text-3xl font-bold text-gray-800">Gestor de Culto</h1>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setShowTechnical(!showTechnical)} className="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-md flex items-center gap-2 text-sm">
                                        <icons.Settings size={16} /> <span>Técnico</span>
                                    </button>
                                    <button onClick={() => setMode(mode === 'planning' ? 'presentation' : 'planning')} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center gap-2">
                                        {mode === 'planning' ? <icons.Play size={18}/> : <icons.Settings size={18}/>}
                                        <span>{mode === 'planning' ? 'Modo Ao Vivo' : 'Planejamento'}</span>
                                    </button>
                                </div>
                            </div>
                            {mode === 'planning' ? (
                                <PlanningView 
                                    plan={plan} 
                                    onCultInfoChange={handleCultInfoChange} 
                                    showTechnical={showTechnical} 
                                    onAddItem={addItem} 
                                    onUpdateItem={updateItem} 
                                    onDeleteItem={deleteItem} 
                                    onMoveItem={moveItem} 
                                    onDownloadTemplate={handleDownloadExcelTemplate} 
                                    onImportClick={() => fileInputRef.current.click()} 
                                    presetsCollectionRef={presetsCollectionRef}
                                    onPlanUpdate={updatePlan}
                                    onNewPlan={handleNewPlan}
                                />
                            ) : (
                                <PresentationView state={{plan, live}} onLiveUpdate={updateLive} onPlanUpdate={updatePlan} isReadOnly={false} />
                            )}
                            <input type="file" accept=".xlsx, .xls" ref={fileInputRef} className="hidden-file-input" onChange={handleImportExcel} />
                        </div>
                    </div>
                </>
            );
        };
        
        // NOVO: Componente de Modal para Presets
        const PresetsModal = ({ show, onClose, presetsCollectionRef, onPlanUpdate }) => {
            const [presets, setPresets] = useState([]);
            const { firestore } = window;
            const { modalState, showModal, hideModal } = useModal();

            useEffect(() => {
                if (!show) return;
                const fetchPresets = async () => {
                    const snapshot = await firestore.getDocs(presetsCollectionRef);
                    setPresets(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                };
                fetchPresets();
            }, [show, presetsCollectionRef]);

            const handleLoad = (preset) => {
                 showModal({
                    title: "Carregar Preset",
                    content: <p>Isso substituirá a ordem de culto atual. Deseja continuar?</p>,
                    footer: <>
                        <button onClick={hideModal} className="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button onClick={() => {
                            onPlanUpdate({ items: preset.items, cultInfo: preset.cultInfo });
                            hideModal();
                            onClose();
                        }} className="px-4 py-2 bg-blue-600 text-white rounded-md">Carregar</button>
                    </>
                });
            };

            const handleDelete = (presetId, presetName) => {
                showModal({
                    title: "Excluir Preset",
                    content: <p>Tem certeza que deseja excluir o preset "{presetName}"? Esta ação não pode ser desfeita.</p>,
                    footer: <>
                        <button onClick={hideModal} className="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button onClick={async () => {
                            const docRef = firestore.doc(presetsCollectionRef, presetId);
                            await firestore.deleteDoc(docRef);
                            setPresets(prev => prev.filter(p => p.id !== presetId));
                            hideModal();
                        }} className="px-4 py-2 bg-red-600 text-white rounded-md">Excluir</button>
                    </>
                });
            };

            return (
                <>
                    <Modal {...modalState} onClose={hideModal} />
                    <Modal show={show} onClose={onClose} title="Gerenciar Presets">
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {presets.length > 0 ? presets.map(p => (
                                <div key={p.id} className="flex justify-between items-center p-2 border rounded-md hover:bg-gray-50">
                                    <span>{p.name}</span>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleLoad(p)} className="bg-green-500 text-white px-3 py-1 text-sm rounded">Carregar</button>
                                        <button onClick={() => handleDelete(p.id, p.name)} className="bg-red-500 text-white p-1.5 text-sm rounded"><icons.Trash2 size={16}/></button>
                                    </div>
                                </div>
                            )) : <p className="text-gray-500">Nenhum preset salvo.</p>}
                        </div>
                    </Modal>
                </>
            );
        };

        const PlanningView = ({ plan, onCultInfoChange, showTechnical, onAddItem, onUpdateItem, onDeleteItem, onMoveItem, onDownloadTemplate, onImportClick, presetsCollectionRef, onPlanUpdate, onNewPlan }) => {
            const [showPresetsModal, setShowPresetsModal] = useState(false);
            const { firestore } = window;
            const { modalState, showModal, hideModal } = useModal();

            const handleSavePreset = () => {
                const presetName = prompt("Digite um nome para este preset:", "Modelo de Culto Padrão");
                if (!presetName || !presetName.trim()) return;
                
                showModal({
                    title: "Salvar Preset",
                    content: <p>Deseja salvar a ordem de culto atual como um novo preset chamado "{presetName}"?</p>,
                    footer: <>
                        <button onClick={hideModal} className="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button onClick={async () => {
                            const presetData = { name: presetName.trim(), savedAt: new Date().toISOString(), items: plan.items, cultInfo: plan.cultInfo };
                            await firestore.addDoc(presetsCollectionRef, presetData);
                            hideModal();
                        }} className="px-4 py-2 bg-indigo-500 text-white rounded-md">Salvar</button>
                    </>
                });
            };

            return ( <>
                <PresetsModal show={showPresetsModal} onClose={() => setShowPresetsModal(false)} presetsCollectionRef={presetsCollectionRef} onPlanUpdate={onPlanUpdate} />
                <Modal {...modalState} onClose={hideModal} />
                <div className="bg-white rounded-lg p-6 mb-6 shadow-sm"> <h2 className="text-xl font-semibold mb-4">Informações do Culto</h2> <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"> <InfoInput label="Data" type="text" value={plan.cultInfo.date} onChange={e => onCultInfoChange('date', e.target.value)} /> <InfoInput label="Coordenador Técnico" value={plan.cultInfo.coordenadorTecnico} onChange={e => onCultInfoChange('coordenadorTecnico', e.target.value)} /> <InfoInput label="Staff" value={plan.cultInfo.staff} onChange={e => onCultInfoChange('staff', e.target.value)} /> <InfoInput label="Lead" value={plan.cultInfo.lead} onChange={e => onCultInfoChange('lead', e.target.value)} /> <InfoInput label="Som" value={plan.cultInfo.som} onChange={e => onCultInfoChange('som', e.target.value)} /> <InfoInput label="Projeção" value={plan.cultInfo.projecao} onChange={e => onCultInfoChange('projecao', e.target.value)} /> <InfoInput label="Iluminação" value={plan.cultInfo.iluminacao} onChange={e => onCultInfoChange('iluminacao', e.target.value)} /> <InfoInput label="Transmissão" value={plan.cultInfo.transmissao} onChange={e => onCultInfoChange('transmissao', e.target.value)} /> <InfoInput label="Pregador" value={plan.cultInfo.pregador} onChange={e => onCultInfoChange('pregador', e.target.value)} /> <InfoInput label="Início do Culto" type="time" value={plan.cultInfo.startTime} onChange={e => onCultInfoChange('startTime', e.target.value)} /> </div> </div> <div className="bg-white rounded-lg shadow-sm"> <div className="p-4 border-b flex flex-wrap justify-between items-center gap-3"> <h2 className="text-xl font-semibold">Ordem de Culto</h2> <div className="flex flex-wrap items-center gap-2"> <button onClick={onNewPlan} className="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md flex items-center gap-2 text-sm"><icons.FilePlus size={16}/> Novo Plano</button> <button onClick={onImportClick} className="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md flex items-center gap-2 text-sm"><icons.UploadCloud size={16}/> Importar</button> <button onClick={onDownloadTemplate} className="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md flex items-center gap-2 text-sm"><icons.DownloadCloud size={16}/> Modelo</button> <button onClick={() => setShowPresetsModal(true)} className="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded-md flex items-center gap-2 text-sm"><icons.Save size={16}/> Presets</button> <button onClick={onAddItem} className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md flex items-center gap-2 text-sm"><icons.Plus size={16}/> Adicionar Item</button> </div> </div> <div className="divide-y divide-gray-200"> {plan.items && plan.items.map((item, index) => ( <PlanningItem key={item.id} item={item} index={index} isFirst={index === 0} isLast={index === plan.items.length - 1} showTechnical={showTechnical} onUpdate={onUpdateItem} onDelete={onDeleteItem} onMove={onMoveItem} /> ))} {(!plan.items || plan.items.length === 0) && <p className="p-4 text-gray-500">Nenhum item na ordem de culto. Adicione um para começar ou importe um arquivo.</p>} </div> </div> </> );
        };

        // Componentes InfoInput, PlanningItem, TechDetailsDisplay, PresentationView e TeamView (sem grandes alterações, apenas adaptados para a nova estrutura de estado)
        const InfoInput = ({ label, ...props }) => ( <div> <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label> <input {...props} className="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" /> </div> );
        const PlanningItem = ({ item, index, isFirst, isLast, showTechnical, onUpdate, onDelete, onMove }) => { const handleFieldChange = (field, value) => onUpdate(item.id, { [field]: value }); const handleTechFieldChange = (field, value) => onUpdate(item.id, { technical: { ...item.technical, [field]: value } }); const getTypeColor = type => ({'música': 'bg-blue-100 text-blue-800', 'oração': 'bg-purple-100 text-purple-800', 'palavra': 'bg-green-100 text-green-800', 'técnico': 'bg-orange-100 text-orange-800'})[type] || 'bg-gray-100 text-gray-800'; return ( <div className="p-4 hover:bg-gray-50"> <div className="flex items-start gap-3"> <div className="flex flex-col items-center pt-1"> <button onClick={() => onMove(index, -1)} disabled={isFirst} className="disabled:opacity-30"><icons.ChevronUp size={20} /></button> <span className="font-mono text-lg font-bold text-gray-400">{index + 1}</span> <button onClick={() => onMove(index, 1)} disabled={isLast} className="disabled:opacity-30"><icons.ChevronDown size={20} /></button> </div> <div className="flex-1"> <div className="grid grid-cols-1 md:grid-cols-5 gap-x-4 gap-y-2"> <input type="text" value={item.title} onChange={e => handleFieldChange('title', e.target.value)} placeholder="Título" className="md:col-span-2 border-gray-300 rounded-md shadow-sm text-lg font-semibold"/> <input type="text" value={item.responsible} onChange={e => handleFieldChange('responsible', e.target.value)} placeholder="Responsável" className="border-gray-300 rounded-md shadow-sm"/> <select value={item.type} onChange={e => handleFieldChange('type', e.target.value)} className={`border-gray-300 rounded-md shadow-sm font-medium ${getTypeColor(item.type)}`}> <option value="palavra">Palavra</option> <option value="música">Música</option> <option value="oração">Oração</option> <option value="técnico">Técnico</option> </select> <div className="flex items-center gap-2"> <input type="number" value={item.duration} onChange={e => handleFieldChange('duration', parseInt(e.target.value, 10) || 0)} className="w-20 border-gray-300 rounded-md shadow-sm"/> <span className="text-gray-600">min</span> <span className="font-mono text-gray-800 bg-gray-100 px-2 py-1 rounded-md">{item.startTime}</span> </div> </div> <textarea value={item.description} onChange={e => handleFieldChange('description', e.target.value)} placeholder="Descrição ou detalhes..." className="w-full mt-2 border-gray-300 rounded-md shadow-sm" rows="2"></textarea> {showTechnical && ( <div className="mt-3 bg-gray-50 rounded p-3"> <h4 className="font-semibold text-sm mb-2">Detalhes Técnicos</h4> <div className="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm"> <InfoInput placeholder="Projeção" value={item.technical.projection} onChange={e => handleTechFieldChange('projection', e.target.value)} /> <InfoInput placeholder="Som" value={item.technical.sound} onChange={e => handleTechFieldChange('sound', e.target.value)} /> <InfoInput placeholder="Microfone" value={item.technical.microphone} onChange={e => handleTechFieldChange('microphone', e.target.value)} /> <InfoInput placeholder="Iluminação" value={item.technical.lighting} onChange={e => handleTechFieldChange('lighting', e.target.value)} /> <InfoInput placeholder="Câmera" value={item.technical.camera} onChange={e => handleTechFieldChange('camera', e.target.value)} /> </div> </div> )} </div> <div className="flex flex-col items-center pt-1"> <button onClick={() => onDelete(item.id)} className="text-red-500 hover:text-red-700 p-1"><icons.Trash2 size={18} /></button> </div> </div> </div> ) };
        const TechDetailsDisplay = ({ technical, colorClass = "text-blue-300" }) => { const techKeyTranslations = { projection: 'Projeção', sound: 'Som', microphone: 'Microfone', lighting: 'Iluminação', camera: 'Câmera' }; const techDetails = technical ? Object.entries(technical).filter(([key, value]) => value && value !== '-') : []; if (techDetails.length === 0) return null; return ( <div> <h4 className={`font-semibold ${colorClass} mb-1 flex items-center gap-2`}><icons.Settings size={16} /> Detalhes Técnicos</h4> <div className="flex flex-col space-y-1 text-sm text-gray-300"> {techDetails.map(([key, value]) => ( <div key={key} className="flex items-center gap-2"> {key === 'projection' && <icons.Monitor size={14} />} {key === 'sound' && <icons.Volume2 size={14} />} {key === 'microphone' && <icons.Mic size={14} />} {key === 'lighting' && <icons.Lightbulb size={14} />} {key === 'camera' && <icons.Camera size={14} />} <span>{techKeyTranslations[key] || key}:</span> <span className="font-semibold text-white">{value}</span> </div> ))} </div> </div> ); };
        const TeamView = ({ plan, live }) => { return ( <div className="min-h-screen bg-gray-100 p-4"> <div className="max-w-7xl mx-auto"> <div className="flex flex-wrap justify-between items-center mb-6 gap-4"> <h1 className="text-3xl font-bold text-gray-800">Gestor de Culto - Equipe</h1> </div> <PresentationView state={{plan, live}} isReadOnly={true} /> </div> </div> ); };
        const PresentationView = ({ state, onLiveUpdate, onPlanUpdate, isReadOnly }) => {
            const [displayTime, setDisplayTime] = useState(0);
            const { plan, live } = state;
            const { items, cultInfo } = plan;
            const { currentItemIndex, isRunning, itemStartTime, accumulatedTime, actualStartTime } = live;
            const currentItem = items && items[currentItemIndex];
            const nextItem = items && items[currentItemIndex + 1];
            const { modalState, showModal, hideModal } = useModal();

            useEffect(() => { let interval; if (isRunning) { interval = setInterval(() => { const elapsed = itemStartTime ? (Date.now() - itemStartTime) / 1000 : 0; setDisplayTime(accumulatedTime + elapsed); }, 250); } else { setDisplayTime(accumulatedTime); } return () => clearInterval(interval); }, [isRunning, itemStartTime, accumulatedTime, currentItemIndex]);
            const formatTime = (seconds) => { if (!seconds || seconds < 0) seconds = 0; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; };
            const plannedDurationInSeconds = (currentItem?.duration || 0) * 60;
            const isOvertime = displayTime > plannedDurationInSeconds;
            const progressPercentage = plannedDurationInSeconds > 0 ? Math.min((displayTime / plannedDurationInSeconds) * 100, 100) : 0;
            const balance = useMemo(() => { if (!items) return 0; let initialDelayInMinutes = 0; if (actualStartTime && cultInfo.startTime) { const plannedStart = new Date(`1970-01-01T${cultInfo.startTime}:00`); const actualStart = new Date(actualStartTime); const actualStartOnSameDay = new Date(`1970-01-01T${actualStart.toTimeString().slice(0,8)}`); if (!isNaN(plannedStart) && !isNaN(actualStartOnSameDay)) { initialDelayInMinutes = (actualStartOnSameDay - plannedStart) / (1000 * 60); } } const itemsBalance = items.slice(0, currentItemIndex).reduce((acc, item) => { if (!item.completed) return acc; const planned = item.duration || 0; const actual = item.actualDuration != null ? item.actualDuration / 60 : planned; return acc + (planned - actual); }, 0); return itemsBalance - initialDelayInMinutes; }, [items, currentItemIndex, actualStartTime, cultInfo.startTime]);
            
            const handleToggleTimer = () => { const now = Date.now(); if (isRunning) { const elapsed = itemStartTime ? (now - itemStartTime) / 1000 : 0; onLiveUpdate({ ...live, isRunning: false, accumulatedTime: accumulatedTime + elapsed, itemStartTime: null }); } else { onLiveUpdate({ ...live, isRunning: true, itemStartTime: now, actualStartTime: actualStartTime || new Date().toISOString() }); } };
            const handleResetTimer = () => { onLiveUpdate({ ...live, isRunning: false, itemStartTime: null, accumulatedTime: 0 }); };
            const handleNext = () => { if (!items || currentItemIndex >= items.length - 1) return; const now = Date.now(); const elapsed = isRunning && itemStartTime ? (now - itemStartTime) / 1000 : 0; const finalDuration = accumulatedTime + elapsed; const newItems = items.map((item, index) => index === currentItemIndex ? { ...item, completed: true, actualDuration: finalDuration } : item ); onPlanUpdate({ ...plan, items: newItems }); onLiveUpdate({ ...live, currentItemIndex: currentItemIndex + 1, isRunning: true, itemStartTime: now, accumulatedTime: 0 }); };
            const handlePrevious = () => { if (currentItemIndex <= 0) return; const newItems = items.map((item, index) => index === currentItemIndex - 1 ? { ...item, completed: false, actualDuration: null } : item ); onPlanUpdate({ ...plan, items: newItems }); onLiveUpdate({ ...live, currentItemIndex: currentItemIndex - 1, isRunning: false, itemStartTime: null, accumulatedTime: 0 }); };
            const handleResetWorship = () => {
                showModal({
                    title: "Reiniciar Culto",
                    content: <p>Tem certeza que deseja reiniciar o culto? Todo o progresso será perdido e o cronômetro voltará para o primeiro item.</p>,
                    footer: <>
                        <button onClick={hideModal} className="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button onClick={() => {
                            const resetItems = items.map(item => ({ ...item, completed: false, actualDuration: null }));
                            onPlanUpdate({ ...plan, items: resetItems });
                            onLiveUpdate(getInitialState().live);
                            hideModal();
                        }} className="px-4 py-2 bg-red-600 text-white rounded-md">Reiniciar</button>
                    </>
                });
            };

            if (!currentItem) { return <div className="text-center p-10 bg-white rounded-lg shadow-md"><h2 className="text-2xl font-bold">Culto Finalizado ou sem itens.</h2></div> }
            return (<> <Modal {...modalState} onClose={hideModal} /> <div className="space-y-4"> <div className="bg-white rounded-lg p-3 shadow-md"> <div className="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-700"> <span className="font-semibold">Data: <span className="font-normal">{cultInfo.date}</span></span> <span className="font-semibold">Coord. Técnico: <span className="font-normal">{cultInfo.coordenadorTecnico}</span></span> <span className="font-semibold">Lead: <span className="font-normal">{cultInfo.lead}</span></span> <span className="font-semibold">Pregador: <span className="font-normal">{cultInfo.pregador}</span></span> </div> </div> <div className="bg-gray-800 text-white rounded-lg p-6 shadow-xl"> <div className="flex justify-between items-start"> <div> <h2 className="text-3xl font-bold">{currentItem.title}</h2> <p className="text-lg text-blue-300">{currentItem.responsible}</p> </div> <div className="text-right"> <div className="text-sm text-gray-400">Horário Previsto</div> <div className="text-2xl font-mono">{currentItem.startTime}</div> </div> </div> <div className="my-6 text-center"> <div className={`text-7xl font-mono ${isOvertime ? 'text-red-400' : 'text-green-400'}`}>{formatTime(displayTime)}</div> <div className="text-gray-400">Planejado: {formatTime(plannedDurationInSeconds)}</div> </div> <div className="w-full bg-gray-700 rounded-full h-4 mb-6"> <div className={`h-4 rounded-full transition-all duration-500 ${isOvertime ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${progressPercentage}%` }}/> </div> {(currentItem.description || (currentItem.technical && Object.values(currentItem.technical).some(v => v && v !== '-'))) && ( <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-gray-900/50 p-4 rounded-lg"> {currentItem.description && ( <div> <h4 className="font-semibold text-blue-300 mb-1 flex items-center gap-2"><icons.Info size={16} /> Descrição</h4> <p className="text-sm text-gray-300 whitespace-pre-wrap">{currentItem.description}</p> </div> )} <TechDetailsDisplay technical={currentItem.technical} /> </div> )} {!isReadOnly && ( <div className="flex justify-center flex-wrap gap-4"> <button onClick={handlePrevious} className="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg disabled:opacity-50" disabled={currentItemIndex === 0}>Anterior</button> <button onClick={handleToggleTimer} className={`px-6 py-2 rounded-lg flex items-center gap-2 text-lg ${isRunning ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'}`}> {isRunning ? <icons.Pause size={20}/> : <icons.Play size={20}/>} {isRunning ? 'Pausar' : 'Iniciar'} </button> <button onClick={handleResetTimer} className="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg flex items-center gap-2"><icons.RotateCcw size={18}/> Resetar Timer</button> <button onClick={handleNext} className="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg disabled:opacity-50" disabled={!items || currentItemIndex >= items.length - 1}>Próximo</button> <button onClick={handleResetWorship} className="bg-red-600 hover:bg-red-500 px-4 py-2 rounded-lg flex items-center gap-2"><icons.Power size={18}/> Reiniciar Culto</button> </div> )} </div> {nextItem && ( <div className="bg-gray-700 text-white rounded-lg p-4 shadow-lg opacity-80"> <h3 className="font-semibold text-lg text-yellow-300 mb-2 flex items-center gap-2"> <icons.ChevronRight size={20}/> A Seguir: {nextItem.title} <span className="text-base text-gray-400 font-normal">- {nextItem.responsible}</span> </h3> <div className="grid grid-cols-1 md:grid-cols-2 gap-4"> {nextItem.description && ( <div> <h4 className="font-semibold text-yellow-400 mb-1 flex items-center gap-2"><icons.Info size={16} /> Descrição</h4> <p className="text-sm text-gray-300 whitespace-pre-wrap">{nextItem.description}</p> </div> )} <TechDetailsDisplay technical={nextItem.technical} colorClass="text-yellow-400" /> </div> </div> )} <div className="bg-gray-800 rounded-lg p-4"> <div className="flex justify-between items-center mb-3"> <h3 className="font-semibold text-white">Linha do Tempo</h3> <div className={`text-sm font-semibold px-3 py-1 rounded-full ${balance >= 0 ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}`}> Balanço: {balance >= 0 ? '+' : ''}{Math.round(balance)} min </div> </div> <div className="flex overflow-x-auto gap-3 pb-2"> {items && items.map((item, index) => { const isCurrent = index === currentItemIndex; const isNext = index === currentItemIndex + 1; const borderColor = isCurrent ? 'border-blue-500' : isNext ? 'border-yellow-400' : 'border-gray-600'; const bgColor = isCurrent ? 'bg-gray-700' : 'bg-gray-700/50'; return ( <div key={item.id} className={`flex-shrink-0 w-48 p-3 rounded-lg border-2 transition-all ${borderColor} ${bgColor}`}> <div className="flex justify-between items-start"> <span className="text-xs font-mono text-gray-300">{item.startTime}</span> {item.completed && <icons.CheckCircle size={16} className="text-green-400"/>} </div> <h4 className={`font-semibold text-sm mb-1 ${item.completed ? 'text-gray-400 line-through' : 'text-white'}`}>{item.title}</h4> <div className="text-xs text-gray-400 flex items-center gap-1"><icons.Clock size={12} /> {item.duration} min</div> </div> ); })} </div> </div> </div> </>); };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
</body>
</html>
