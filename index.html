<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Culto & Briefing Pro - V7</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Bibliotecas Externas -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; margin: 0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* Estilo do Modo Ao Vivo - Imersivo */
        .live-bg { background-color: #000000 !important; color: white !important; height: 100vh; width: 100vw; }
        .timer-giant { font-size: min(25vw, 50vh); line-height: 1; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .agora-label { color: #64748b; font-weight: 900; letter-spacing: 0.3em; font-size: 2.5rem; }
        .a-seguir-label { color: #f59e0b; opacity: 0.8; font-weight: 900; letter-spacing: 0.3em; font-size: 2.5rem; }

        @media screen {
            .paper-view {
                width: 210mm;
                min-height: 297mm;
                background: white;
                color: #0f172a;
                box-shadow: 0 0 50px rgba(0,0,0,0.5);
                margin: 0 auto;
                padding: 20mm;
                border-radius: 4px;
            }
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            .paper-view { width: 100%; margin: 0; box-shadow: none; padding: 10mm; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, updateDoc, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey":"AIzaSyCYaOPtQdD1hU29awdgeN-rEGaoLGBGYBM","authDomain":"gestao-de-culto.firebaseapp.com","projectId":"gestao-de-culto","storageBucket":"gestao-de-culto.appspot.com","messagingSenderId":"843566675046","appId":"1:843566675046:web:cc1e54a813827f4502a9a7"}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestao-de-culto-v7';

        window.FB_INSTANCE = {
            app: initializeApp(firebaseConfig),
            auth: getAuth(),
            db: getFirestore(),
            utils: { doc, onSnapshot, setDoc, collection, addDoc, updateDoc, serverTimestamp, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getDocs, deleteDoc },
            appId
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- GLOBAL UTILS ---
        const formatTime = (seconds) => {
            const absSeconds = Math.abs(Math.floor(seconds));
            const mins = Math.floor(absSeconds / 60);
            const secs = absSeconds % 60;
            return `${seconds < 0 ? '-' : ''}${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };

        const calculateTimes = (items, start) => {
            let curr = new Date(`1970-01-01T${start || '00:00'}:00`);
            return items.map(it => {
                const st = isNaN(curr.getTime()) ? '--:--' : curr.toTimeString().slice(0, 5);
                curr.setMinutes(curr.getMinutes() + (Number(it.duration) || 0));
                return { ...it, startTime: st };
            });
        };

        const SvgIcon = ({ size = 24, className = '', children }) => ( 
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg> 
        );

        const icons = {
            Plus: (p) => <SvgIcon {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></SvgIcon>,
            Play: (p) => <SvgIcon {...p}><polygon points="5 3 19 12 5 21 5 3" /></SvgIcon>,
            Pause: (p) => <SvgIcon {...p}><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></SvgIcon>,
            Settings: (p) => <SvgIcon {...p}><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0 2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></SvgIcon>,
            Monitor: (p) => <SvgIcon {...p}><rect x="2" y="3" width="20" height="14" rx="2" ry="2" /><line x1="8" y1="21" x2="16" y2="21" /><line x1="12" y1="17" x2="12" y2="21" /></SvgIcon>,
            Trash2: (p) => <SvgIcon {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></SvgIcon>,
            CheckCircle: (p) => <SvgIcon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></SvgIcon>,
            Roteiro: (p) => <SvgIcon {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /></SvgIcon>,
            Skip: (p) => <SvgIcon {...p}><polygon points="5 4 15 12 5 20 5 4" /><line x1="19" y1="5" x2="19" y2="19" /></SvgIcon>,
            Print: (p) => <SvgIcon {...p}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></SvgIcon>,
            Send: (p) => <SvgIcon {...p}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></SvgIcon>
        };

        // --- SUB-COMPONENTS ---

        const LiveClock = ({ className = '' }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const t = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(t);
            }, []);
            return <div className={className}>{time.toLocaleTimeString('pt-BR')}</div>;
        };

        const App = () => {
            const [view, setView] = useState('planning');
            const [isLoading, setIsLoading] = useState(true);
            const [user, setUser] = useState(null);
            
            const [state, setState] = useState({
                items: [
                    { id: '1', title: 'Cronômetro', duration: 5, responsible: 'Mídia', description: '', technical: { projection: 'Timer 5min', sound: 'Background', lighting: 'Pre-show' }, completed: false, itemColor: '#334155' },
                    { id: '2', title: 'Abertura: Louvor', duration: 15, responsible: 'Min. Louvor', description: 'Tempo de festa, Louve, No meio dos louvores', technical: { projection: 'Lyrics', sound: 'Mix Banda', lighting: 'Wash Colorido' }, completed: false, itemColor: '#4f46e5' },
                    { id: '3', title: 'Palavra de gratidão', duration: 5, responsible: 'Pr Juliano', description: '', technical: { projection: 'Nome Pr Juliano', sound: 'Mic Pr Juliano', lighting: 'Foco Púlpito' }, completed: false, itemColor: '#0891b2' },
                    { id: '4', title: 'Vídeo Retrospectiva', duration: 5, responsible: 'Mídia', description: 'Confirmar arquivo final', technical: { projection: 'Vídeo Retro', sound: 'Áudio Vídeo', lighting: 'Blackout' }, completed: false, itemColor: '#7c3aed' },
                    { id: '5', title: 'Louvor', duration: 15, responsible: 'Min. Louvor', description: 'Algo novo vindo, Santo Pra Sempre, Quem é Esse', technical: { projection: 'Lyrics', sound: 'Mix Banda', lighting: 'Moving Heads' }, completed: false, itemColor: '#4f46e5' },
                    { id: '6', title: 'Reflexão e oração – 2026', duration: 10, responsible: 'Pr Marcio', description: 'Planos, sonhos e metas. Música: Seja o Centro', technical: { projection: 'Versículo', sound: 'Pad fundo', lighting: 'Âmbar' }, completed: false, itemColor: '#059669' },
                    { id: '7', title: 'Ofertório', duration: 10, responsible: 'Pr Erick', description: 'Oferta de gratidão. Louvor: Gratidão + Te Agradeço', technical: { projection: 'QR Code', sound: 'Mic Pr Erick', lighting: 'Geral' }, completed: false, itemColor: '#ca8a04' },
                    { id: '8', title: 'Palavra', duration: 15, responsible: 'Pr Felipe', description: 'Louvor: Novo dia, Enquanto oro', technical: { projection: 'Esboço', sound: 'Mic Pr Felipe', lighting: 'Foco' }, completed: false, itemColor: '#2563eb' },
                    { id: '9', title: 'Ceia', duration: 15, responsible: 'Pastores', description: 'Louvor: Nada além do sangue', technical: { projection: 'Ceia', sound: 'Reverb Alto', lighting: 'Vermelho' }, completed: false, itemColor: '#dc2626' },
                    { id: '10', title: 'Mensagem', duration: 30, responsible: 'Pr Hugo Campos', description: 'Palavra da virada', technical: { projection: 'Esboço', sound: 'Mic Pr Hugo', lighting: 'Púlpito' }, completed: false, itemColor: '#1e293b' },
                    { id: '11', title: 'Apelo', duration: 5, responsible: 'Pr Hugo Campos', description: '', technical: { projection: 'Background', sound: 'Teclado fundo', lighting: 'Warm White' }, completed: false, itemColor: '#b91c1c' },
                    { id: '12', title: 'Louvor: Eu e minha casa', duration: 5, responsible: 'Min. Louvor', description: '', technical: { projection: 'Lyrics', sound: 'Mix Banda', lighting: 'Full Stage' }, completed: false, itemColor: '#4f46e5' },
                    { id: '13', title: 'Oração com as famílias', duration: 10, responsible: 'Pastores', description: '', technical: { projection: 'Família', sound: 'BG Instrumental', lighting: 'House 50%' }, completed: false, itemColor: '#059669' },
                    { id: '14', title: 'Virada', duration: 10, responsible: 'Todos', description: 'Contagem regressiva', technical: { projection: 'Countdown', sound: 'Celebração', lighting: 'Strobe' }, completed: false, itemColor: '#f59e0b' }
                ],
                cultInfo: { titulo: 'Culto da Virada', tema: 'O que almejamos para 2026?', date: '2025-12-31', startTime: '21:25', pregador: 'Pr Hugo Campos', dirigente: 'Louvor + Pastores', local: 'Templo Sede' },
                equipes: { coordenador: '', saude: 'Equipe Alpha', sonoplastia: 'Mesa 1', projecao: 'Multimídia', transmissao: 'Live', recepcao: 'Diaconato' },
                obsDepartamentos: { midia: '- Haverá thumb específica para projeção?\n- Haverá slide na pregação?', musica: '- Banda posicionada: 21:00\n- Música ambiente (Spotify): 21:10', staff: '- Coordenador geral definido?', diaconato: '- Água e microfone para pregadores.' },
                liveState: { currentItemIndex: 0, isRunning: false, itemStartTime: null, accumulatedTime: 0, actualStartTime: null, announcement: null }
            });

            const { db, appId, utils } = window.FB_INSTANCE;

            // --- SYNC ENGINE ---
            useEffect(() => {
                const initFb = async () => {
                    const { auth, utils, db, appId } = window.FB_INSTANCE;
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await utils.signInWithCustomToken(auth, __initial_auth_token);
                    } else { await utils.signInAnonymously(auth); }

                    utils.onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if (u) {
                            utils.onSnapshot(utils.doc(db, "artifacts", appId, "public", "data", "live", "state"), (snap) => {
                                if (snap.metadata.hasPendingWrites) return; 
                                if (snap.exists()) {
                                    setState(snap.data());
                                }
                                setIsLoading(false);
                            });
                        }
                    });
                };
                initFb();
            }, []);

            const sync = async (updater) => {
                if (!user) return;
                const { db, utils, appId } = window.FB_INSTANCE;
                const next = typeof updater === 'function' ? updater(state) : updater;
                await utils.setDoc(utils.doc(db, "artifacts", appId, "public", "data", "live", "state"), next, { merge: true });
            };

            const toggleTimer = () => {
                if (state.liveState.isRunning) {
                    const elapsed = state.liveState.itemStartTime ? (Date.now() - state.liveState.itemStartTime) / 1000 : 0;
                    sync({
                        ...state,
                        liveState: { ...state.liveState, isRunning: false, accumulatedTime: state.liveState.accumulatedTime + elapsed, itemStartTime: null }
                    });
                } else {
                    sync({ ...state, liveState: { ...state.liveState, isRunning: true, itemStartTime: Date.now() } });
                }
            };

            const handleNext = () => {
                if (state.liveState.currentItemIndex >= state.items.length - 1) return;
                const nextIdx = state.liveState.currentItemIndex + 1;
                const newItems = state.items.map((it, idx) => idx === state.liveState.currentItemIndex ? { ...it, completed: true } : it);
                sync({
                    ...state,
                    items: newItems,
                    liveState: { ...state.liveState, currentItemIndex: nextIdx, itemStartTime: Date.now(), accumulatedTime: 0, isRunning: true }
                });
            };

            // --- TAB: PLANNING ---
            const PlanningTab = () => (
                <div className="max-w-5xl mx-auto space-y-8 animate-fade-in no-print pb-32 pt-4">
                    <section className="glass p-8 rounded-[2.5rem] border border-white/5 space-y-6">
                        <h2 className="text-2xl font-black">Informações Básicas</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div>
                                <label className="text-[10px] font-black text-slate-500 uppercase block mb-1">Título</label>
                                <input className="w-full bg-slate-900 border border-white/10 rounded-xl p-3 outline-none focus:border-indigo-500 font-bold" value={state.cultInfo.titulo} onChange={e => sync(p => ({...p, cultInfo: {...p.cultInfo, titulo: e.target.value}}))} />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-500 uppercase block mb-1">Início</label>
                                <input type="time" className="w-full bg-slate-900 border border-white/10 rounded-xl p-3 outline-none focus:border-indigo-500 font-mono text-indigo-400 font-bold" value={state.cultInfo.startTime} onChange={e => sync(p => ({...p, cultInfo: {...p.cultInfo, startTime: e.target.value}}))} />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-500 uppercase block mb-1">Local</label>
                                <input className="w-full bg-slate-900 border border-white/10 rounded-xl p-3" value={state.cultInfo.local} onChange={e => sync(p => ({...p, cultInfo: {...p.cultInfo, local: e.target.value}}))} />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-500 uppercase block mb-1">Data</label>
                                <input type="date" className="w-full bg-slate-900 border border-white/10 rounded-xl p-3" value={state.cultInfo.date} onChange={e => sync(p => ({...p, cultInfo: {...p.cultInfo, date: e.target.value}}))} />
                            </div>
                        </div>
                    </section>

                    <section className="glass p-8 rounded-[2.5rem] border border-white/5">
                        <div className="flex justify-between items-center mb-8">
                            <h2 className="text-2xl font-black uppercase tracking-tighter">Liturgia</h2>
                            <button onClick={() => {
                                const newItem = { id: crypto.randomUUID(), title: 'Novo Momento', duration: 10, responsible: '', description: '', technical: { projection: '', sound: '', lighting: '' }, completed: false, itemColor: '#3B82F6' };
                                sync(p => ({...p, items: [...p.items, newItem]}));
                            }} className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold text-xs uppercase flex items-center gap-2 hover:bg-indigo-50 transition-all shadow-lg">
                                <icons.Plus size={16}/> Adicionar Item
                            </button>
                        </div>
                        <div className="space-y-4">
                            {calculateTimes(state.items, state.cultInfo.startTime).map((it) => (
                                <div key={it.id} className="p-6 bg-slate-950/40 rounded-3xl border border-white/5 group">
                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6 items-center">
                                        <div className="md:col-span-1 text-center">
                                            <span className="font-mono font-bold text-indigo-500 text-sm">{it.startTime}</span>
                                            <input type="color" className="mt-1 block mx-auto" value={it.itemColor} onChange={e => sync(p => ({...p, items: p.items.map(x => x.id === it.id ? {...x, itemColor: e.target.value} : x)}))} />
                                        </div>
                                        <div className="md:col-span-4">
                                            <input className="bg-transparent text-xl font-black outline-none w-full text-slate-100 placeholder:text-slate-800" placeholder="Título" value={it.title} onChange={e => sync(p => ({...p, items: p.items.map(x => x.id === it.id ? {...x, title: e.target.value} : x)}))} />
                                            <input className="bg-transparent text-[10px] font-black text-slate-600 outline-none uppercase block mt-1 tracking-widest" placeholder="RESPONSÁVEL" value={it.responsible} onChange={e => sync(p => ({...p, items: p.items.map(x => x.id === it.id ? {...x, responsible: e.target.value} : x)}))} />
                                        </div>
                                        <div className="md:col-span-1 flex items-center gap-2 bg-black/40 p-2 rounded-xl border border-white/5 justify-center">
                                            <input type="number" className="bg-transparent w-8 text-center font-bold text-sm" value={it.duration} onChange={e => sync(p => ({...p, items: p.items.map(x => x.id === it.id ? {...x, duration: Number(e.target.value)} : x)}))} />
                                            <span className="text-[9px] font-black text-slate-600 uppercase">min</span>
                                        </div>
                                        <div className="md:col-span-5 grid grid-cols-3 gap-2">
                                            {['projection', 'sound', 'lighting'].map(tk => (
                                                <input key={tk} placeholder={tk.toUpperCase()} className="bg-white/5 border border-white/10 rounded-lg p-2 text-[10px] outline-none text-slate-300 font-bold" value={it.technical[tk]} onChange={e => sync(p => ({...p, items: p.items.map(x => x.id === it.id ? {...x, technical: {...x.technical, [tk]: e.target.value}} : x)}))} />
                                            ))}
                                        </div>
                                        <div className="md:col-span-1 text-right">
                                            <button onClick={() => sync(p => ({...p, items: p.items.filter(x => x.id !== it.id)}))} className="text-slate-700 hover:text-red-500">
                                                <icons.Trash2 size={20}/>
                                            </button>
                                        </div>
                                    </div>
                                    <textarea className="w-full bg-black/20 mt-4 rounded-xl p-3 text-xs text-slate-500 outline-none resize-none italic" placeholder="Setlist ou observações..." value={it.description} onChange={e => sync(p => ({...p, items: p.items.map(x => x.id === it.id ? {...x, description: e.target.value} : x)}))} />
                                </div>
                            ))}
                        </div>
                    </section>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <section className="glass p-8 rounded-[2.5rem] border border-white/5">
                            <h2 className="text-2xl font-black mb-8 uppercase tracking-tighter">Escala de Equipes</h2>
                            <div className="space-y-4">
                                {Object.keys(state.equipes).map(role => (
                                    <div key={role} className="flex flex-col">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 tracking-widest">{role}</label>
                                        <input className="bg-slate-900 border border-white/10 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none text-slate-200" value={state.equipes[role]} onChange={e => sync(p => ({...p, equipes: {...p.equipes, [role]: e.target.value}}))} />
                                    </div>
                                ))}
                            </div>
                        </section>
                        <section className="glass p-8 rounded-[2.5rem] border border-white/5 text-white">
                            <h2 className="text-2xl font-black mb-8 uppercase tracking-tighter">Notas Departamentais</h2>
                            <div className="space-y-6">
                                {[
                                    {id: 'midia', l: 'Mídia', c: 'text-orange-500'},
                                    {id: 'musica', l: 'Música', c: 'text-blue-500'},
                                    {id: 'staff', l: 'Staff', c: 'text-green-500'},
                                    {id: 'diaconato', l: 'Diaconato / Púlpito', c: 'text-purple-500'}
                                ].map(dept => (
                                    <div key={dept.id}>
                                        <label className={`text-[10px] font-black uppercase tracking-widest block mb-2 ${dept.c}`}>{dept.l}</label>
                                        <textarea rows="3" className="w-full bg-slate-900 border border-white/10 rounded-xl p-3 text-xs outline-none focus:border-indigo-500 resize-none text-slate-300 font-medium" value={state.obsDepartamentos[dept.id]} onChange={e => sync(p => ({...p, obsDepartamentos: {...p.obsDepartamentos, [dept.id]: e.target.value}}))} />
                                    </div>
                                ))}
                            </div>
                        </section>
                    </div>
                </div>
            );

            // --- TAB: LIVE (IMERSIVO - REQUESTED FORMAT) ---
            const LiveTab = () => {
                const it = state.items[state.liveState.currentItemIndex];
                const next = state.items[state.liveState.currentItemIndex + 1];
                const [elapsed, setElapsed] = useState(state.liveState.accumulatedTime);

                useEffect(() => {
                    if (!state.liveState.isRunning || !state.liveState.itemStartTime) {
                        setElapsed(state.liveState.accumulatedTime);
                        return;
                    }
                    const i = setInterval(() => {
                        setElapsed(state.liveState.accumulatedTime + (Date.now() - state.liveState.itemStartTime) / 1000);
                    }, 250);
                    return () => clearInterval(i);
                }, [state.liveState]);

                const remaining = (it?.duration * 60) - elapsed;

                return (
                    <div className="h-full w-full fixed inset-0 z-0 live-bg text-white flex flex-col p-8 lg:p-16 animate-fade-in no-print pt-24 overflow-hidden select-none">
                        {/* Header Superior */}
                        <div className="w-full flex justify-between items-start shrink-0">
                            <div className="max-w-[70%]">
                                <div className="agora-label uppercase tracking-widest">AGORA</div>
                                <div className="text-8xl font-black mt-2 tracking-tighter truncate" style={{color: it?.itemColor || '#FFFFFF'}}>{it?.title || 'FIM'}</div>
                                <div className="text-3xl text-slate-400 font-medium italic mt-4 truncate">{it?.responsible}</div>
                            </div>
                            <LiveClock className="text-8xl text-slate-400 font-mono font-bold" />
                        </div>

                        {/* Cronômetro Gigante Centralizado */}
                        <div className="flex-grow flex flex-col items-center justify-center relative min-h-0">
                            <div className={`timer-giant ${remaining < 0 ? 'text-red-500' : remaining < 60 ? 'text-yellow-400' : 'text-white'}`}>
                                {formatTime(remaining)}
                            </div>
                            
                            {/* Instruções Técnicas na Lateral Direita */}
                            <div className="absolute right-0 top-1/2 -translate-y-1/2 space-y-6 max-w-xs text-right hidden lg:flex flex-col">
                                {['projection', 'sound', 'lighting'].map(tk => it?.technical[tk] && (
                                    <div key={tk} className="bg-white/5 border-r-4 border-indigo-500 p-5 backdrop-blur-md rounded-l-3xl shadow-2xl transition-all">
                                        <div className="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-1">{tk === 'projection' ? 'PROJEÇÃO' : tk.toUpperCase()}</div>
                                        <div className="text-2xl font-bold text-slate-100 leading-tight">{it.technical[tk]}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Footer - A Seguir + Controlos */}
                        <div className="w-full flex justify-between items-end border-t border-white/10 pt-8 pb-4 shrink-0">
                            <div className="text-left flex-1 max-w-[65%]">
                                <div className="a-seguir-label uppercase tracking-widest">A SEGUIR</div>
                                {next ? (
                                    <>
                                        <div className="text-7xl font-bold text-amber-400 tracking-tighter mt-2 truncate">{next.title}</div>
                                        <div className="text-2xl text-slate-500 font-medium mt-1 truncate">{next.responsible}</div>
                                    </>
                                ) : <div className="text-5xl text-slate-700 font-black mt-2 uppercase tracking-widest italic tracking-tighter">Agenda Finalizada</div>}
                            </div>
                            
                            {/* Controlos Ao Vivo */}
                            <div className="flex gap-6 pb-2">
                                <button onClick={toggleTimer} title="Play/Pause" className={`p-8 rounded-[2.5rem] transition-all shadow-2xl ${state.liveState.isRunning ? 'bg-amber-600' : 'bg-emerald-600'} hover:scale-110 active:scale-90`}>
                                    {state.liveState.isRunning ? <icons.Pause size={48}/> : <icons.Play size={48}/>}
                                </button>
                                <button onClick={handleNext} title="Próximo Bloco" className="p-8 bg-indigo-600 rounded-[2.5rem] hover:bg-indigo-500 transition-all shadow-2xl hover:scale-110 active:scale-90 text-white">
                                    <icons.Skip size={48}/>
                                </button>
                            </div>
                        </div>

                        {/* Notas no Centro Inferior */}
                        {it?.description && (
                            <div className="absolute bottom-4 left-1/2 -translate-x-1/2 glass px-12 py-3 rounded-full border border-white/10 animate-pulse-soft max-w-3xl z-50">
                                <p className="text-slate-300 text-lg font-bold italic text-center truncate">"{it.description}"</p>
                            </div>
                        )}
                    </div>
                );
            };

            const RoteiroTab = () => (
                <div className="animate-fade-in pb-32 pt-4">
                    <div className="paper-view text-slate-900">
                        <div className="flex justify-between items-start border-b-4 border-slate-900 pb-6 mb-8">
                            <div className="flex-1 text-slate-900">
                                <h1 className="text-4xl font-serif font-bold uppercase tracking-tight leading-tight">{state.cultInfo.titulo}</h1>
                                <p className="text-xl text-slate-600 italic font-serif mt-1">{state.cultInfo.tema}</p>
                            </div>
                            <div className="text-right">
                                <div className="bg-slate-900 text-white px-4 py-1 mb-2 font-bold uppercase tracking-widest text-[10px] inline-block font-sans">Briefing Pro</div>
                                <div className="text-xl font-bold font-mono">{new Date(state.cultInfo.date + 'T00:00:00').toLocaleDateString('pt-BR')}</div>
                                <div className="text-lg text-slate-500 font-mono">{state.cultInfo.startTime}h • {state.cultInfo.local || 'Auditório'}</div>
                            </div>
                        </div>
                        <div className="grid grid-cols-12 gap-8 mb-10 text-slate-900">
                            <div className="col-span-4 space-y-6">
                                <section>
                                    <h3 className="font-black uppercase text-[10px] text-slate-400 mb-3 border-b border-slate-100 pb-1">Escala Técnica</h3>
                                    <div className="space-y-1 text-sm">
                                        {Object.entries(state.equipes).map(([k, v]) => (
                                            <p key={k}><strong className="capitalize text-slate-400 text-[10px] uppercase">{k}:</strong> {v || '-'}</p>
                                        ))}
                                    </div>
                                </section>
                                <section>
                                    <h3 className="font-black uppercase text-[10px] text-slate-400 mb-3 border-b border-slate-100 pb-1 tracking-widest">Responsáveis</h3>
                                    <div className="space-y-1 text-sm">
                                        <p><strong className="text-slate-400 uppercase text-[10px]">Pregador:</strong> {state.cultInfo.pregador || '-'}</p>
                                        <p><strong className="text-slate-400 uppercase text-[10px]">Dirigente:</strong> {state.cultInfo.dirigente || '-'}</p>
                                    </div>
                                </section>
                            </div>
                            <div className="col-span-8">
                                <h3 className="font-black uppercase text-[10px] text-slate-400 mb-4 border-b border-slate-100 pb-1 tracking-widest font-sans">Ordem do Culto</h3>
                                <div className="space-y-4">
                                    {calculateTimes(state.items, state.cultInfo.startTime).map((it) => (
                                        <div key={it.id} className="flex gap-4 items-start border-b border-slate-50 pb-2 text-slate-900 font-sans">
                                            <span className="font-mono font-bold text-slate-300 w-12 text-sm">{it.startTime}</span>
                                            <div className="flex-1">
                                                <div className="flex justify-between">
                                                    <span className="font-bold text-slate-800">{it.title}</span>
                                                    <span className="text-[10px] font-bold text-slate-400 uppercase">{it.responsible || 'Equipa'}</span>
                                                </div>
                                                <p className="text-xs text-slate-500 italic mt-0.5">{it.description}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-6 bg-slate-50 p-6 rounded-lg border border-slate-100 text-slate-900 mb-10">
                            {Object.entries(state.obsDepartamentos).map(([k, v]) => v && (
                                <div key={k} className="text-xs">
                                    <strong className="uppercase text-slate-400 mb-1 block text-[10px] tracking-widest font-sans">{k}</strong>
                                    <p className="text-slate-600 whitespace-pre-line leading-relaxed">{v}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-center mt-12 no-print pb-10">
                        <button onClick={() => window.print()} className="px-12 py-4 bg-white text-slate-900 rounded-3xl font-black shadow-2xl flex items-center gap-3 hover:scale-105 active:scale-95 transition-all uppercase text-xs tracking-widest">
                            <icons.Print size={24}/> Imprimir Ordem de Culto
                        </button>
                    </div>
                </div>
            );

            // --- MAIN SHELL ---
            return (
                <div className="h-screen flex flex-col overflow-hidden bg-slate-950">
                    <nav className="glass h-16 shrink-0 flex items-center justify-between px-8 z-[100] no-print relative shadow-2xl border-b border-white/5">
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-600/30">
                                <icons.Monitor className="text-white" size={24}/>
                            </div>
                            <div className="hidden sm:block">
                                <h1 className="text-xl font-black uppercase tracking-tighter leading-none italic text-slate-100">Briefing <span className="text-indigo-500 font-black">Pro</span></h1>
                                <p className="text-[9px] text-slate-500 font-bold uppercase tracking-widest tracking-tighter">Control Center v7.0</p>
                            </div>
                        </div>

                        <div className="flex bg-slate-900/50 p-1 rounded-2xl border border-white/5">
                            {[
                                { id: 'planning', l: 'Planejamento', i: <icons.Settings size={14}/> },
                                { id: 'live', l: 'Ao Vivo', i: <icons.Play size={14}/> },
                                { id: 'roteiro', l: 'Roteiro', i: <icons.Roteiro size={14}/> }
                            ].map(t => (
                                <button key={t.id} onClick={() => setView(t.id)} className={`px-4 sm:px-6 py-2 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-2 ${view === t.id ? 'bg-indigo-600 text-white shadow-xl scale-105' : 'text-slate-500 hover:text-slate-300'}`}>
                                    {t.i} <span className="hidden md:inline">{t.l}</span>
                                </button>
                            ))}
                        </div>

                        <div className="text-right">
                            <LiveClock className="text-2xl font-mono font-bold text-indigo-400 leading-none" />
                        </div>
                    </nav>

                    <main className={`flex-1 overflow-y-auto no-scrollbar ${view === 'live' ? 'p-0' : 'p-8'}`}>
                        {view === 'planning' && <PlanningTab />}
                        {view === 'live' && <LiveTab />}
                        {view === 'roteiro' && <RoteiroTab />}
                    </main>

                    {/* Alerta Overlay */}
                    {state.liveState.alert && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 w-[90%] max-w-4xl bg-red-600 text-white p-10 rounded-[3rem] shadow-[0_0_150px_rgba(220,38,38,0.6)] z-[200] flex items-center gap-10 animate-bounce border-8 border-white/20">
                            <div className="p-5 bg-white/20 rounded-full shrink-0"><icons.Monitor size={60}/></div>
                            <div>
                                <span className="text-xs font-black uppercase tracking-[0.4em] opacity-70 block mb-2 tracking-widest">Mensagem da Direção</span>
                                <h2 className="text-5xl font-black uppercase leading-tight tracking-tighter">{state.liveState.alert.message}</h2>
                            </div>
                        </div>
                    )}
                    
                    <div className="fixed bottom-10 right-10 z-[100] no-print">
                        <button onClick={() => {
                            const m = prompt("Alerta para a equipe:");
                            if (m) {
                                sync(p => ({...p, liveState: {...p.liveState, alert: {message: m, time: Date.now()}}}));
                                setTimeout(() => sync(p => ({...p, liveState: {...p.liveState, alert: null}})), 8000);
                            }
                        }} title="Enviar Alerta" className="w-16 h-16 bg-red-600 text-white rounded-full flex items-center justify-center shadow-2xl hover:scale-110 active:scale-95 transition-all">
                            <icons.Plus className="rotate-45" size={28}/>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
