<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Culto & Briefing Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- jsPDF e AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f1f5f9; margin: 0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* Estilo para a folha de Roteiro (Briefing Pro) */
        .paper-view {
            background: white;
            color: #0f172a;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 210mm;
            min-height: 297mm;
            margin: 2rem auto;
            padding: 20mm;
            border-radius: 4px;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .paper-view { width: 100%; margin: 0; box-shadow: none; padding: 10mm; color: black; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 22px;
            height: 22px;
            padding: 0;
            background: transparent;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: 1px solid #475569; }

        .timer-giant { font-size: clamp(6rem, 18vw, 15rem); line-height: 1; }
        .team-text-large { font-size: 22px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK Modular -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, updateDoc, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Parâmetros do ambiente (preenchidos automaticamente ou com fallback para teste)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey":"AIzaSyCYaOPtQdD1hU29awdgeN-rEGaoLGBGYBM","authDomain":"gestao-de-culto.firebaseapp.com","projectId":"gestao-de-culto","storageBucket":"gestao-de-culto.appspot.com","messagingSenderId":"843566675046","appId":"1:843566675046:web:cc1e54a813827f4502a9a7"}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestao-premium-v8';

        window.FB_INSTANCE = {
            app: initializeApp(firebaseConfig),
            auth: getAuth(),
            db: getFirestore(),
            utils: { doc, onSnapshot, setDoc, collection, addDoc, updateDoc, serverTimestamp, signInAnonymously, onAuthStateChanged, getDocs, deleteDoc },
            appId
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- ICONS (SVG) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const paths = {
                play: <path d="m5 3 14 9-14 9V3z" />,
                pause: <path d="M6 4h4v16H6zm8 0h4v16h-4z" />,
                plus: <path d="M12 5v14M5 12h14" />,
                settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />,
                chevron: <path d="m9 18 6-6-6-6" />,
                file: <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" />,
                music: <path d="M9 18V5l12-2v13" /><circle cx="6" cy="18" r="3" /><circle cx="18" cy="16" r="3" />,
                clock: <circle cx="12" cy="12" r="10" /><path d="M12 6v6l4 2" />,
                send: <path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" />,
                print: <polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {paths[name]}
                </svg>
            );
        };

        // --- COMPONENTS ---

        const formatTime = (seconds) => {
            const abs = Math.abs(Math.floor(seconds));
            const m = Math.floor(abs / 60);
            const s = abs % 60;
            return `${seconds < 0 ? '-' : ''}${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        };

        const calculateTimes = (items, start) => {
            let curr = new Date(`1970-01-01T${start || '00:00'}:00`);
            return items.map(it => {
                const st = isNaN(curr.getTime()) ? '--:--' : curr.toTimeString().slice(0, 5);
                curr.setMinutes(curr.getMinutes() + (Number(it.duration) || 0));
                return { ...it, startTime: st };
            });
        };

        const App = () => {
            const [view, setView] = useState('planejamento'); // 'planejamento', 'aovivo', 'roteiro'
            const [user, setUser] = useState(null);
            const [localTime, setLocalTime] = useState(new Date());
            const [state, setState] = useState({
                items: [],
                setlist: [],
                equipes: { som: '', projecao: '', luz: '', staff: '', recepcao: '' },
                deptNotes: { midia: '', louvor: '', geral: '' },
                cultInfo: { titulo: 'Culto de Celebração', tema: '', date: new Date().toISOString().split('T')[0], startTime: '19:00', pregador: '', dirigente: '', local: '' },
                liveState: { currentItemIndex: 0, isRunning: false, itemStartTime: null, accumulatedTime: 0, announcement: null }
            });
            const [presets, setPresets] = useState([]);
            const [loadedPreset, setLoadedPreset] = useState(null);

            const fb = window.FB_INSTANCE;

            useEffect(() => {
                const timer = setInterval(() => setLocalTime(new Date()), 1000);
                
                if (fb) {
                    fb.utils.signInAnonymously(fb.auth);
                    fb.utils.onAuthStateChanged(fb.auth, u => {
                        setUser(u);
                        if (u) {
                            fb.utils.onSnapshot(fb.utils.doc(fb.db, "artifacts", fb.appId, "public", "data", "live"), snap => {
                                if (snap.exists()) setState(snap.data());
                            });
                            fb.utils.onSnapshot(fb.utils.collection(fb.db, "artifacts", fb.appId, "public", "data", "presets"), snap => {
                                setPresets(snap.docs.map(d => ({id: d.id, ...d.data()})));
                            });
                        }
                    });
                }
                return () => clearInterval(timer);
            }, []);

            const sync = async (next) => {
                if (user && fb) {
                    const data = typeof next === 'function' ? next(state) : next;
                    await fb.utils.setDoc(fb.utils.doc(fb.db, "artifacts", fb.appId, "public", "data", "live"), data, { merge: true });
                }
            };

            const handleUpdate = (updater) => {
                setState(prev => {
                    const next = typeof updater === 'function' ? updater(prev) : updater;
                    sync(next);
                    return next;
                });
            };

            // --- TABS RENDERING ---
            return (
                <div className="min-h-screen flex flex-col h-screen overflow-hidden">
                    {/* Top Navbar */}
                    <nav className="bg-slate-900 border-b border-white/5 p-4 flex justify-between items-center z-[100] shadow-2xl no-print shrink-0">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-600/20"><Icon name="settings" size={20} className="text-white"/></div>
                            <div>
                                <h1 className="font-black text-lg tracking-tighter uppercase leading-none italic">Gestor de Culto</h1>
                                <p className="text-[9px] font-bold text-slate-500 uppercase tracking-widest mt-1">Briefing Pro v8.5</p>
                            </div>
                        </div>

                        <div className="flex bg-black/40 p-1 rounded-xl border border-white/5 mx-4">
                            {[
                                {id: 'planejamento', label: 'Planejamento', icon: 'settings'},
                                {id: 'aovivo', label: 'Ao Vivo', icon: 'play'},
                                {id: 'roteiro', label: 'Roteiro', icon: 'file'}
                            ].map(tab => (
                                <button 
                                    key={tab.id}
                                    onClick={() => setView(tab.id)}
                                    className={`px-5 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest flex items-center gap-2 transition-all ${view === tab.id ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
                                >
                                    <Icon name={tab.icon} size={14} /> <span>{tab.label}</span>
                                </button>
                            ))}
                        </div>

                        <div className="text-right">
                            <div className="text-2xl font-mono font-bold text-indigo-400 leading-none">{localTime.toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit', second: '2-digit'})}</div>
                        </div>
                    </nav>

                    {/* Main Workspace */}
                    <main className="flex-grow overflow-y-auto no-scrollbar">
                        {view === 'planejamento' && <PlanningTab state={state} handleUpdate={handleUpdate} presets={presets} loadedPreset={loadedPreset} setLoadedPreset={setLoadedPreset} />}
                        {view === 'aovivo' && <LiveDashboard state={state} handleUpdate={handleUpdate} formatSecs={formatTime} />}
                        {view === 'roteiro' && <ScriptTab state={state} handleUpdate={handleUpdate} />}
                    </main>

                    <AnnouncementBanner announcement={state.liveState.announcement} />
                </div>
            );
        };

        // --- SUB TABS ---

        const PlanningTab = ({ state, handleUpdate, presets, loadedPreset, setLoadedPreset }) => {
            const handleAddItem = () => {
                const newItem = { id: crypto.randomUUID(), title: 'Novo Momento', duration: 5, responsible: '', description: '', techColors: { lighting: '#3b82f6', projection: '#ef4444' }, technical: { lighting: '', projection: '', sound: '' }, completed: false };
                handleUpdate(s => ({...s, items: [...s.items, newItem]}));
            };

            return (
                <div className="p-4 lg:p-10 max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade-in no-print">
                    <div className="lg:col-span-8 space-y-6">
                        <div className="bg-slate-900 border border-white/5 p-8 rounded-[2.5rem] shadow-xl">
                            <div className="flex justify-between items-center mb-8 border-b border-white/5 pb-6">
                                <h2 className="text-2xl font-black uppercase tracking-tighter italic">Liturgia</h2>
                                <button onClick={handleAddItem} className="bg-white text-black px-6 py-2.5 rounded-full text-xs font-black uppercase flex items-center gap-2 hover:bg-indigo-400 transition-all shadow-lg">
                                    <Icon name="plus" size={16} /> Adicionar Item
                                </button>
                            </div>

                            <div className="space-y-4">
                                {calculateTimes(state.items, state.cultInfo.startTime).map((it, idx) => (
                                    <div key={it.id} className="p-5 bg-black/40 border border-white/5 rounded-3xl flex gap-6 hover:border-indigo-500/50 transition-all group">
                                        <div className="flex flex-col items-center gap-3 shrink-0 border-r border-white/5 pr-4 pt-1">
                                            <span className="text-[10px] font-bold text-slate-500 font-mono tracking-tighter">{it.startTime}</span>
                                            <div className="flex flex-col gap-2">
                                                <input type="color" value={it.techColors?.lighting} onChange={e => handleUpdate(s => {
                                                    const ni = [...s.items]; ni[idx].techColors = {...ni[idx].techColors, lighting: e.target.value}; return {...s, items: ni};
                                                })} />
                                                <input type="color" value={it.techColors?.projection} onChange={e => handleUpdate(s => {
                                                    const ni = [...s.items]; ni[idx].techColors = {...ni[idx].techColors, projection: e.target.value}; return {...s, items: ni};
                                                })} />
                                            </div>
                                        </div>
                                        <div className="flex-grow grid grid-cols-1 md:grid-cols-2 gap-8">
                                            <div className="space-y-4">
                                                <input className="w-full text-xl font-black text-white bg-transparent border-none p-0 focus:ring-0 placeholder:text-slate-700" placeholder="Título do Momento" value={it.title} onChange={e => handleUpdate(s => { const ni = [...s.items]; ni[idx].title = e.target.value; return {...s, items: ni}; })} />
                                                <div className="flex gap-4">
                                                    <input className="text-xs text-indigo-400 font-bold bg-transparent border-none p-0 w-1/2" placeholder="Responsável" value={it.responsible} onChange={e => handleUpdate(s => { const ni = [...s.items]; ni[idx].responsible = e.target.value; return {...s, items: ni}; })} />
                                                    <div className="flex items-center gap-2 bg-white/5 px-2 py-1 rounded-lg">
                                                        <Icon name="clock" size={12} className="text-slate-500" />
                                                        <input type="number" className="text-xs font-bold text-slate-300 w-10 bg-transparent text-center" value={it.duration} onChange={e => handleUpdate(s => { const ni = [...s.items]; ni[idx].duration = e.target.value; return {...s, items: ni}; })} />
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 gap-2">
                                                <input className="text-[10px] p-2.5 bg-black/40 border border-white/5 rounded-xl text-slate-300 placeholder:text-slate-600 focus:border-indigo-500/50 outline-none" placeholder="Instrução Luz" value={it.technical?.lighting} onChange={e => handleUpdate(s => { const ni = [...s.items]; ni[idx].technical = {...ni[idx].technical, lighting: e.target.value}; return {...s, items: ni}; })} />
                                                <input className="text-[10px] p-2.5 bg-black/40 border border-white/5 rounded-xl text-slate-300 placeholder:text-slate-600 focus:border-indigo-500/50 outline-none" placeholder="Instrução Projeção" value={it.technical?.projection} onChange={e => handleUpdate(s => { const ni = [...s.items]; ni[idx].technical = {...ni[idx].technical, projection: e.target.value}; return {...s, items: ni}; })} />
                                            </div>
                                        </div>
                                        <button onClick={() => handleUpdate(s => ({...s, items: s.items.filter(x => x.id !== it.id)}))} className="text-slate-700 hover:text-red-500 self-center p-2"><Icon name="trash" size={20}/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="lg:col-span-4 space-y-6">
                        <section className="bg-indigo-900/20 border border-indigo-500/10 p-8 rounded-[2.5rem] shadow-xl">
                            <h3 className="text-[10px] font-black uppercase tracking-widest text-indigo-400 mb-6">Presets & Modelos</h3>
                            <div className="space-y-4">
                                <select className="w-full p-4 bg-black/40 border border-white/5 rounded-2xl text-sm text-slate-300 outline-none" value={loadedPreset?.id || ''} onChange={e => {
                                    const p = presets.find(x => x.id === e.target.value);
                                    if(p) { handleUpdate({...p, liveState: state.liveState}); setLoadedPreset(p); }
                                }}>
                                    <option value="">Carregar...</option>
                                    {presets.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                </select>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={async () => {
                                        const n = prompt("Nome do preset:"); if(!n) return;
                                        const db = window.FB_INSTANCE.db;
                                        const docRef = await window.FB_INSTANCE.utils.addDoc(window.FB_INSTANCE.utils.collection(db, "artifacts", window.FB_INSTANCE.appId, "public", "data", "presets"), { ...state, name: n, savedAt: Date.now() });
                                        setLoadedPreset({id: docRef.id, name: n});
                                    }} className="bg-white text-black py-3 rounded-2xl font-black text-xs uppercase shadow-lg active:scale-95 transition-all">Salvar Novo</button>
                                    <button onClick={async () => {
                                        if(!loadedPreset) return;
                                        const db = window.FB_INSTANCE.db;
                                        await window.FB_INSTANCE.utils.updateDoc(window.FB_INSTANCE.utils.doc(db, "artifacts", window.FB_INSTANCE.appId, "public", "data", "presets", loadedPreset.id), { ...state, savedAt: Date.now() });
                                        alert("Atualizado!");
                                    }} disabled={!loadedPreset} className="bg-indigo-600 text-white py-3 rounded-2xl font-black text-xs uppercase disabled:opacity-30 active:scale-95 transition-all">Atualizar</button>
                                </div>
                            </div>
                        </section>

                        <section className="bg-slate-900 border border-white/5 p-8 rounded-[2.5rem] shadow-xl">
                            <h3 className="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-6">Info do Evento</h3>
                            <div className="space-y-4">
                                <input className="w-full bg-black/40 border border-white/5 rounded-xl p-3 text-sm text-white" placeholder="Título do Culto" value={state.cultInfo.titulo} onChange={e => handleUpdate(s => ({...s, cultInfo: {...s.cultInfo, titulo: e.target.value}}))}/>
                                <input type="time" className="w-full bg-black/40 border border-white/5 rounded-xl p-3 text-sm text-indigo-400 font-bold" value={state.cultInfo.startTime} onChange={e => handleUpdate(s => ({...s, cultInfo: {...s.cultInfo, startTime: e.target.value}}))}/>
                                {['pregador', 'local', 'tema'].map(f => (
                                    <input key={f} className="w-full bg-black/40 border border-white/5 rounded-xl p-3 text-sm text-white" placeholder={f.toUpperCase()} value={state.cultInfo[f]} onChange={e => handleUpdate(s => ({...s, cultInfo: {...s.cultInfo, [f]: e.target.value}}))}/>
                                ))}
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        const LiveDashboard = ({ state, handleUpdate, formatSecs }) => {
            const it = state.items[state.liveState.currentItemIndex];
            const next = state.items[state.liveState.currentItemIndex + 1];
            const [elapsed, setElapsed] = useState(0);

            useEffect(() => {
                if (!state.liveState.isRunning || !state.liveState.itemStartTime) { setElapsed(state.liveState.accumulatedTime); return; }
                const i = setInterval(() => setElapsed(state.liveState.accumulatedTime + (Date.now() - state.liveState.itemStartTime)/1000), 250);
                return () => clearInterval(i);
            }, [state.liveState]);

            const planned = (it?.duration || 0) * 60;
            const diff = planned - elapsed;
            const isOvertime = diff < 0;

            return (
                <div className="p-10 space-y-10 animate-fade-in no-print">
                    {/* 3 Column Layout Real */}
                    <div className="grid grid-cols-12 gap-8 h-[600px]">
                        
                        {/* Col 1: Current / Timer */}
                        <div className="col-span-5 bg-slate-900 border border-white/5 p-12 rounded-[3rem] flex flex-col shadow-2xl relative overflow-hidden">
                            <div className="absolute top-0 left-12 right-12 h-1 bg-indigo-600 rounded-full shadow-[0_0_20px_rgba(79,70,229,0.5)]"></div>
                            <div>
                                <span className="bg-indigo-600 text-white text-[10px] px-3 py-1 rounded font-black uppercase tracking-widest">Agora</span>
                                <h2 className="text-6xl font-black text-white mt-6 tracking-tighter leading-[0.9] uppercase">{it?.title || 'FIM'}</h2>
                                <p className="text-slate-400 mt-4 text-2xl font-medium italic">{it?.responsible || '-'}</p>
                            </div>
                            <div className="flex-grow flex flex-col items-center justify-center py-10">
                                <div className={`timer-giant font-mono tracking-tighter ${isOvertime ? 'text-red-500' : diff < 60 ? 'text-yellow-400' : 'text-white'}`}>
                                    {formatSecs(diff)}
                                </div>
                                <p className="text-slate-600 font-black uppercase tracking-[0.4em] text-xs mt-10 opacity-30">Contagem de Tempo</p>
                            </div>
                            <div className="flex justify-center gap-4 border-t border-white/5 pt-8">
                                <button onClick={() => handleUpdate(s => ({...s, liveState: {...s.liveState, isRunning: !s.liveState.isRunning, itemStartTime: s.liveState.isRunning ? null : Date.now(), accumulatedTime: elapsed}}))} className={`flex-1 py-5 rounded-2xl font-black uppercase text-xs tracking-widest ${state.liveState.isRunning ? 'bg-amber-600 text-white' : 'bg-emerald-600 text-white'}`}>
                                    {state.liveState.isRunning ? 'Pausar Relógio' : 'Iniciar Momento'}
                                </button>
                            </div>
                        </div>

                        {/* Col 2: Technical Notes */}
                        <div className="col-span-4 bg-slate-900/40 border border-white/5 p-10 rounded-[3rem] flex flex-col shadow-xl">
                            <h3 className="text-[10px] font-black uppercase tracking-[0.3em] text-slate-600 mb-12">Instruções Técnicas</h3>
                            <div className="space-y-12 overflow-y-auto no-scrollbar">
                                {['lighting', 'projection', 'sound'].map(k => {
                                    const val = it?.technical?.[k];
                                    const color = it?.techColors?.[k];
                                    if(!val || val === '-') return null;
                                    return (
                                        <div key={k} className="flex gap-6 items-start animate-in slide-in-from-left duration-500">
                                            <div className="w-16 h-16 rounded-2xl border-4 border-white/10 shrink-0 shadow-lg" style={{backgroundColor: color || '#1e293b'}}></div>
                                            <div>
                                                <span className="text-[10px] font-black uppercase text-slate-500 block mb-1.5 tracking-widest">{k === 'lighting' ? 'Luz' : k === 'projection' ? 'Projeção' : 'Som'}</span>
                                                <p className="text-4xl font-black text-white leading-tight">{val}</p>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Col 3: Up Next */}
                        <div className="col-span-3 bg-white/5 border border-white/5 p-10 rounded-[3rem] flex flex-col opacity-60 hover:opacity-100 transition-all duration-500">
                             <span className="text-yellow-500 font-black uppercase text-[10px] tracking-[0.3em] block mb-10">Próximo</span>
                             {next ? (
                                 <div className="space-y-10 flex-grow flex flex-col">
                                     <h3 className="text-5xl font-black text-white leading-[0.9] tracking-tighter uppercase">{next.title}</h3>
                                     <div className="pt-10 border-t border-white/10 space-y-6">
                                         <p className="text-slate-400 text-xl font-bold uppercase tracking-widest">{next.responsible}</p>
                                         <p className="text-slate-500 text-lg leading-snug italic">"{next.description || 'Sem notas preparadas.'}"</p>
                                     </div>
                                 </div>
                             ) : <div className="flex-grow flex items-center justify-center font-black text-slate-800 uppercase tracking-[0.5em] italic">Agenda Finalizada</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const ScriptTab = ({ state, handleUpdate }) => {
            const onExportPDF = () => {
                const doc = new window.jsPDF();
                doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.text(state.cultInfo.titulo, 20, 20);
                doc.setFontSize(11); doc.setTextColor(100); doc.text(`${state.cultInfo.date} • ${state.cultInfo.startTime}h • ${state.cultInfo.tema || ''}`, 20, 30);
                doc.autoTable({
                    startY: 40,
                    head: [['Hora', 'Momento', 'Responsável', 'Duração', 'Descrição']],
                    body: state.items.map(it => [it.startTime, it.title, it.responsible, `${it.duration}m`, it.description]),
                    headStyles: {fillColor: [15, 23, 42]}, theme: 'grid'
                });
                doc.save(`briefing_${state.cultInfo.titulo}.pdf`);
            };

            return (
                <div className="animate-fade-in flex flex-col items-center gap-10 pb-40">
                    <div className="flex gap-4 no-print glass p-4 rounded-3xl border border-white/10 shadow-2xl">
                        <button onClick={() => window.print()} className="bg-slate-800 text-white px-8 py-3 rounded-2xl font-black uppercase text-xs flex items-center gap-2 hover:bg-slate-700 transition-all"><Icon name="print" size={16}/> Imprimir</button>
                        <button onClick={onExportPDF} className="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-black uppercase text-xs flex items-center gap-2 hover:bg-indigo-500 transition-all shadow-lg"><Icon name="pdf" size={16}/> Baixar PDF</button>
                    </div>

                    <div className="paper-view font-sans border-t-[12px] border-slate-950">
                         <div className="flex justify-between items-start mb-12 border-b-4 border-slate-900 pb-10">
                             <div>
                                 <h1 className="text-5xl font-serif font-black uppercase tracking-tighter text-slate-950 leading-[0.9] mb-4">{state.cultInfo.titulo}</h1>
                                 <p className="text-2xl text-slate-500 italic font-serif leading-relaxed">{state.cultInfo.tema || "Celebração Especial"}</p>
                             </div>
                             <div className="text-right">
                                 <div className="bg-slate-950 text-white px-6 py-2 text-[10px] font-black uppercase tracking-[0.3em] mb-4 inline-block">BRIEFING PRO</div>
                                 <div className="text-2xl font-black text-slate-950 font-mono tracking-tighter">{state.cultInfo.date}</div>
                                 <div className="text-xl font-bold text-indigo-600 font-mono mt-1">{state.cultInfo.startTime}h</div>
                             </div>
                         </div>

                         <div className="grid grid-cols-12 gap-12">
                             <div className="col-span-4 space-y-10 border-r border-slate-100 pr-10 shrink-0">
                                 <section>
                                     <h3 className="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400 mb-5 border-b border-slate-50 pb-2">Informação Base</h3>
                                     <div className="space-y-4">
                                         <div><span className="text-[9px] uppercase font-bold text-slate-400 block">Pregador</span><p className="font-black text-slate-900 text-xl tracking-tight leading-none">{state.cultInfo.pregador || '-'}</p></div>
                                         <div><span className="text-[9px] uppercase font-bold text-slate-400 block">Dirigente</span><p className="font-bold text-slate-700 text-lg leading-none">{state.cultInfo.dirigente || '-'}</p></div>
                                     </div>
                                 </section>
                                 <section>
                                     <h3 className="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400 mb-5 border-b border-slate-50 pb-2">Equipa Técnica</h3>
                                     <div className="space-y-3 text-sm">
                                         {Object.entries(state.equipes).map(([k, v]) => (
                                             <p key={k} className="leading-tight"><strong className="capitalize text-slate-400 text-[10px] block mb-0.5">{k}</strong> <span className="font-bold text-slate-800">{v || '-'}</span></p>
                                         ))}
                                     </div>
                                 </section>
                             </div>

                             <div className="col-span-8 flex flex-col">
                                 <h3 className="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400 mb-8 border-b border-slate-900 pb-2 tracking-[0.2em]">Fluxo de Liturgia</h3>
                                 <div className="space-y-8 relative border-l-4 border-slate-50 ml-2">
                                     {state.items.map((it) => (
                                         <div key={it.id} className="relative pl-10">
                                             <div className="absolute left-[-12px] top-1.5 w-5 h-5 rounded-full bg-white border-4 border-slate-200"></div>
                                             <div className="flex justify-between items-baseline mb-1">
                                                 <h4 className="text-2xl font-black text-slate-900 uppercase tracking-tighter leading-none">{it.title}</h4>
                                                 <span className="text-sm font-mono font-bold text-slate-300 tracking-tighter italic">{it.startTime} <span className="text-[10px] opacity-60 ml-1">({it.duration}m)</span></span>
                                             </div>
                                             <p className="text-[10px] text-indigo-600 font-bold uppercase tracking-widest mb-3">{it.responsible || 'Coletivo'}</p>
                                             <div className="text-sm text-slate-600 bg-slate-50 p-4 rounded-2xl border border-slate-100 italic leading-relaxed">
                                                 {it.description || "Sem notas preparadas para este bloco."}
                                             </div>
                                         </div>
                                     ))}
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            );
        };

        // --- PUBLIC VIEWS (COMPONENTS) ---

        const PublicTeamView = ({ state, localTime, formatSecs }) => (
            <div className="h-screen bg-black text-white p-10 flex flex-col gap-10 overflow-hidden font-sans select-none">
                 <div className="flex justify-between items-end border-b border-white/10 pb-8 shrink-0">
                    <div>
                        <span className="text-indigo-500 font-black uppercase tracking-[0.4em] text-sm mb-3 block">Painel de Operações Profissional</span>
                        <h1 className="text-8xl font-black uppercase tracking-tighter leading-none">{state.cultInfo.titulo}</h1>
                    </div>
                    <div className="text-right">
                        <div className="text-9xl font-mono leading-none tracking-tighter text-white font-bold">{localTime.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' })}</div>
                        <div className="text-slate-500 text-xl mt-4 uppercase tracking-[0.3em] font-bold">{state.cultInfo.date}</div>
                    </div>
                </div>
                <Live3ColumnView state={state} formatSecs={formatSecs} />
                <TimelineBase state={state} isReadOnly={true} />
            </div>
        );

        const GiantTimerView = ({ state, localTime, formatSecs }) => {
            const it = state.items[state.liveState.currentItemIndex];
            const [display, setDisplay] = useState(0);
            useEffect(() => {
                if (!state.liveState.isRunning || !state.liveState.itemStartTime) { setDisplay(state.liveState.accumulatedTime); return; }
                const i = setInterval(() => setDisplay(state.liveState.accumulatedTime + (Date.now() - state.liveState.itemStartTime)/1000), 200);
                return () => clearInterval(i);
            }, [state.liveState]);
            const diff = (it?.duration * 60) - display;
            return (
                <div className="h-screen w-screen bg-black text-white flex flex-col items-center justify-center p-10 font-mono select-none overflow-hidden">
                    <div className="text-4xl opacity-20 mb-8 tracking-[0.2em]">{localTime.toLocaleTimeString()}</div>
                    <h2 className="text-6xl font-black uppercase tracking-widest text-slate-800 text-center mb-16 px-10 truncate w-full">{it?.title || 'FIM'}</h2>
                    <div className={`timer-giant leading-none tracking-tighter ${diff < 0 ? 'text-red-600' : diff < 60 ? 'text-yellow-500' : 'text-emerald-500'}`}>
                        {formatSecs(diff)}
                    </div>
                </div>
            );
        };

        const StageView = ({ state, localTime, formatSecs }) => {
            const it = state.items[state.liveState.currentItemIndex];
            const next = state.items[state.liveState.currentItemIndex + 1];
            const [display, setDisplay] = useState(0);
            useEffect(() => {
                if (!state.liveState.isRunning || !state.liveState.itemStartTime) { setDisplay(state.liveState.accumulatedTime); return; }
                const i = setInterval(() => setDisplay(state.liveState.accumulatedTime + (Date.now() - state.liveState.itemStartTime)/1000), 200);
                return () => clearInterval(i);
            }, [state.liveState]);
            const diff = (it?.duration * 60) - display;

            return (
                <div className="h-screen w-screen bg-black text-white flex flex-col p-16 font-sans select-none overflow-hidden">
                     <div className="flex justify-between items-start w-full border-b border-white/10 pb-10">
                         <div>
                             <span className="text-slate-500 font-black uppercase tracking-[0.4em] text-2xl block mb-4">MOMENTO ATUAL</span>
                             <h1 className="text-[10rem] font-black tracking-tighter leading-[0.8]" style={{color: it?.itemColor || '#FFF'}}>{it?.title || 'Agenda Encerrada'}</h1>
                         </div>
                         <div className="text-9xl text-slate-300 font-mono font-bold tracking-tighter">{localTime.toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'})}</div>
                     </div>
                     <div className="flex-grow flex items-center justify-center">
                         <div className={`text-[36vw] font-mono font-bold leading-none tracking-tighter ${diff < 0 ? 'text-red-500' : diff < 60 ? 'text-yellow-400' : 'text-white'}`}>
                             {formatSecs(diff)}
                         </div>
                     </div>
                     <div className="mt-auto border-t border-white/10 pt-10">
                         <span className="text-amber-500 font-black uppercase tracking-[0.4em] text-2xl block mb-4">A PREPARAR</span>
                         <h2 className="text-8xl font-black text-amber-400 opacity-90 tracking-tighter italic uppercase">{next?.title || '---'}</h2>
                     </div>
                </div>
            );
        };

        const TimelineBase = ({ state, isReadOnly }) => {
            const stats = useMemo(() => {
                if (!state.items.length) return { balance: 0, end: '--:--' };
                let b = 0;
                state.items.forEach(it => { if(it.completed) b += (it.duration - (it.actualDuration/60 || it.duration)); });
                const rem = state.items.slice(state.liveState.currentItemIndex).reduce((acc, i) => acc + (i.duration || 0), 0);
                const eTime = new Date(Date.now() + rem * 60000);
                return { balance: b, end: eTime.toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'}) };
            }, [state.items, state.liveState.currentItemIndex]);

            return (
                <div className={`${isReadOnly ? 'bg-white/5 border-white/10 shadow-2xl' : 'bg-slate-900 border-white/5'} border p-6 rounded-[2.5rem] shrink-0`}>
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-black text-[10px] uppercase tracking-[0.3em] text-slate-500">Fluxo Litúrgico em Tempo Real</h3>
                        <div className="flex gap-6">
                            <span className={`text-[10px] font-black px-5 py-2 rounded-full uppercase tracking-widest ${stats.balance >= 0 ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'}`}>Balanço: {Math.round(stats.balance)}m</span>
                            <span className="text-[10px] font-black px-5 py-2 rounded-full bg-indigo-500/20 text-indigo-400 uppercase tracking-[0.2em] border border-indigo-500/20">Prev. Fim: {stats.end}</span>
                        </div>
                    </div>
                    <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar">
                        {state.items.map((it, idx) => (
                            <div key={it.id} className={`flex-shrink-0 w-56 p-5 rounded-[1.8rem] border-2 transition-all duration-700 ${idx === state.liveState.currentItemIndex ? 'border-indigo-600 bg-indigo-600/20 scale-105 shadow-xl' : 'border-transparent opacity-20'}`}>
                                <div className="flex justify-between items-center mb-2 text-[10px] font-black font-mono">
                                    <span className="text-indigo-400">{it.startTime}</span>
                                    {it.completed && <Icon name="check" size={16} className="text-emerald-500" />}
                                </div>
                                <h4 className="font-black text-sm truncate uppercase tracking-tight text-white">{it.title}</h4>
                                <div className="text-[9px] text-slate-500 font-bold uppercase mt-2 tracking-widest">{it.duration} min</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AnnouncementBanner = ({ announcement }) => {
            const [show, setShow] = useState(false);
            useEffect(() => {
                if (announcement && (Date.now() - announcement.timestamp) < (announcement.duration * 1000)) {
                    setShow(true);
                    const t = setTimeout(() => setShow(false), (announcement.duration * 1000));
                    return () => clearTimeout(t);
                }
            }, [announcement]);
            if (!show) return null;
            return (
                <div className="fixed top-12 left-1/2 -translate-x-1/2 w-[90%] max-w-5xl bg-yellow-400 text-black p-12 rounded-[4rem] border-8 border-white shadow-[0_60px_150px_rgba(0,0,0,1)] z-[500] flex items-center gap-12 animate-bounce no-print">
                    <div className="bg-black p-6 rounded-3xl text-yellow-400 shadow-2xl"><Icon name="settings" size={64} /></div>
                    <div className="flex-grow text-center"><h2 className="text-[5.5rem] font-black uppercase leading-none tracking-tighter">{announcement.message}</h2></div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
